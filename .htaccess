# ----------------------------------------------------------------------
# tommysuzanne.com - Apache .htaccess (static site, behind Cloudflare)
# ----------------------------------------------------------------------

# Custom 404 page (absolute path from the site root)
ErrorDocument 404 /404.html

# ----------------------------------------------------------------------
# Basic hardening (deny dotfiles, but keep .well-known for ACME, etc.)
# ----------------------------------------------------------------------
<IfModule mod_rewrite.c>
RewriteEngine On

# Deny access to hidden files/directories (e.g., .git, .env, .DS_Store)
# Allow .well-known/ for Let's Encrypt / security.txt / etc.
RewriteRule "(^|/)\.(?!well-known(?:/|$))" - [F,L]
</IfModule>

# ----------------------------------------------------------------------
# Canonical redirects (HTTPS + non-www), proxy/CDN aware
# ----------------------------------------------------------------------
<IfModule mod_rewrite.c>
# Normalize www -> apex (single hop, always to https)
RewriteCond %{HTTP_HOST} ^www\.tommysuzanne\.com$ [NC]
RewriteRule ^ https://tommysuzanne.com%{REQUEST_URI} [R=301,L,NE]

# Force HTTPS using either native HTTPS flag OR X-Forwarded-Proto from proxy/CDN.
RewriteCond %{HTTP_HOST} ^tommysuzanne\.com$ [NC]
RewriteCond %{HTTPS} !=on
RewriteCond %{HTTP:X-Forwarded-Proto} !https [NC]
RewriteRule ^ https://tommysuzanne.com%{REQUEST_URI} [R=301,L,NE]

# Avoid duplicate home URL
RewriteRule ^index\.html$ / [R=301,L,NE]
</IfModule>

# ----------------------------------------------------------------------
# Security headers
# ----------------------------------------------------------------------
<IfModule mod_headers.c>
# Clickjacking protection
Header always set X-Frame-Options "DENY"

# MIME sniffing protection
Header always set X-Content-Type-Options "nosniff"

# Referrer policy (good default for a content site)
Header always set Referrer-Policy "strict-origin-when-cross-origin"

# Disable legacy cross-domain policies (Flash/Acrobat)
Header always set X-Permitted-Cross-Domain-Policies "none"

# Permissions Policy: keep tight by default (adjust if you add features later)
Header always set Permissions-Policy "accelerometer=(), autoplay=(), camera=(), clipboard-read=(), clipboard-write=(), display-capture=(), encrypted-media=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), midi=(), payment=(), publickey-credentials-get=(), usb=()"

# CSP: strict origins, but allows inline because the site currently uses:
# - <script type="application/ld+json"> inline blocks
# - onload=... on <link rel="stylesheet"> in index.html
# If you later remove inline JS/handlers, we can tighten by removing 'unsafe-inline'.
Header always set Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://static.cloudflareinsights.com; script-src-elem 'self' 'unsafe-inline' https://static.cloudflareinsights.com; connect-src 'self' https://cloudflareinsights.com https://static.cloudflareinsights.com; form-action 'none'; upgrade-insecure-requests"
</IfModule>

# ----------------------------------------------------------------------
# Compression (gzip via mod_deflate)
# Note: Cloudflare can also compress at the edge; this is still fine for origin.
# ----------------------------------------------------------------------
<IfModule mod_deflate.c>
# Compress text-based assets
AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/javascript application/json application/xml text/xml image/svg+xml

# Don't waste CPU compressing already-compressed/binary formats
SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png|webp|avif|ico|mp4|mp3|zip|gz|tgz|bz2|rar|7z|pdf)$" no-gzip dont-vary

<IfModule mod_headers.c>
Header append Vary "Accept-Encoding"
</IfModule>
</IfModule>

# ----------------------------------------------------------------------
# Caching
# Strategy:
# - HTML: revalidate (fast updates)
# - CSS/JS: 7 days
# - Images/icons: 30 days
# If you adopt asset versioning (hash or ?v=), we can safely raise to 1 year + immutable.
# ----------------------------------------------------------------------
<IfModule mod_expires.c>
ExpiresActive On

# HTML: essentially no caching
ExpiresByType text/html "access plus 0 seconds"

# CSS/JS: moderate
ExpiresByType text/css "access plus 7 days"
ExpiresByType application/javascript "access plus 7 days"
ExpiresByType text/javascript "access plus 7 days"

# Images
ExpiresByType image/svg+xml "access plus 30 days"
ExpiresByType image/x-icon "access plus 30 days"
ExpiresByType image/gif "access plus 30 days"
ExpiresByType image/png "access plus 30 days"
ExpiresByType image/jpeg "access plus 30 days"
ExpiresByType image/webp "access plus 30 days"
ExpiresByType image/avif "access plus 30 days"
</IfModule>

<IfModule mod_headers.c>
# HTML: always revalidate
<FilesMatch "\.html$">
Header set Cache-Control "max-age=0, must-revalidate"
</FilesMatch>

# CSS/JS: cacheable
<FilesMatch "\.(?:css|js)$">
Header set Cache-Control "public, max-age=604800"
</FilesMatch>

# Images/icons: longer cache
<FilesMatch "\.(?:svg|ico|gif|png|jpe?g|webp|avif)$">
Header set Cache-Control "public, max-age=2592000"
</FilesMatch>
</IfModule>

# ----------------------------------------------------------------------
# Optional: HSTS (NOT enabled per your choice)
# Only enable once you're 100% sure HTTPS is permanent for the domain.
# ----------------------------------------------------------------------
# <IfModule mod_headers.c>
# Header always set Strict-Transport-Security "max-age=31536000"
# </IfModule>
